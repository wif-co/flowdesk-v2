<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlowDesk</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-deep: #08080C;
      --bg-base: #0C0C12;
      --bg-elevated: #13131A;
      --bg-float: #1A1A24;
      --border-subtle: rgba(255,255,255,0.06);
      --border-default: rgba(255,255,255,0.1);
      --text-primary: #F0F0F5;
      --text-secondary: #9090A0;
      --text-tertiary: #606070;
      --accent-cyan: #00D4AA;
      --accent-violet: #8B5CF6;
      --accent-amber: #F59E0B;
      --accent-rose: #F43F5E;
      --accent-blue: #3B82F6;
      --glow-cyan: rgba(0,212,170,0.4);
      --glow-violet: rgba(139,92,246,0.4);
      --font-display: 'Space Grotesk', sans-serif;
      --font-body: 'DM Sans', sans-serif;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --radius-xl: 28px;
    }
    [data-theme="light"] {
      --bg-deep: #F8F8FA;
      --bg-base: #FFFFFF;
      --bg-elevated: #FFFFFF;
      --bg-float: #F0F0F5;
      --border-subtle: rgba(0,0,0,0.04);
      --border-default: rgba(0,0,0,0.08);
      --text-primary: #18181B;
      --text-secondary: #52525B;
      --text-tertiary: #A1A1AA;
      --accent-cyan: #059669;
      --accent-violet: #7C3AED;
      --accent-amber: #D97706;
      --accent-rose: #DC2626;
      --accent-blue: #2563EB;
      --glow-cyan: rgba(5,150,105,0.15);
      --glow-violet: rgba(124,58,237,0.15);
    }
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    html { font-size: 16px; }
    body { 
      font-family: var(--font-body); 
      background: var(--bg-deep); 
      color: var(--text-primary); 
      line-height: 1.5; 
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }
    
    /* Ambient Background */
    .ambient-bg {
      position: fixed;
      inset: 0;
      z-index: -1;
      overflow: hidden;
    }
    .ambient-bg::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(ellipse at 20% 20%, rgba(0,212,170,0.08) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, rgba(139,92,246,0.06) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(59,130,246,0.04) 0%, transparent 60%);
      animation: ambientShift 30s ease-in-out infinite;
    }
    @keyframes ambientShift {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(2%, 1%) rotate(1deg); }
      66% { transform: translate(-1%, 2%) rotate(-1deg); }
    }
    
    /* Auth Overlay */
    .auth-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-deep);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.4s ease;
    }
    .auth-overlay.hidden { display: none; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    
    .auth-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      padding: 48px 40px;
      max-width: 380px;
      width: 90%;
      text-align: center;
      box-shadow: 
        0 0 0 1px var(--border-subtle),
        0 24px 48px -12px rgba(0,0,0,0.4),
        0 0 120px -40px var(--glow-cyan);
      animation: cardReveal 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @keyframes cardReveal {
      from { opacity: 0; transform: translateY(20px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    .auth-icon {
      font-size: 3.5rem;
      margin-bottom: 12px;
      animation: iconBounce 2s ease-in-out infinite;
    }
    @keyframes iconBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
    }
    .auth-logo {
      font-family: var(--font-display);
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-cyan);
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    .auth-subtitle {
      color: var(--text-tertiary);
      font-size: 0.875rem;
      margin-bottom: 32px;
    }
    .remember-label {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-secondary);
      justify-content: center;
    }
    .remember-checkbox { display: none; }
    .remember-check {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-default);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      background: var(--bg-float);
    }
    .remember-check::after {
      content: '‚úì';
      font-size: 12px;
      color: var(--accent-cyan);
      opacity: 0;
      transform: scale(0);
      transition: all 0.2s ease;
    }
    .remember-checkbox:checked + .remember-check {
      border-color: var(--accent-cyan);
      background: rgba(0,212,170,0.1);
    }
    .remember-checkbox:checked + .remember-check::after {
      opacity: 1;
      transform: scale(1);
    }
    .auth-input {
      width: 100%;
      padding: 14px 18px;
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      background: var(--bg-float);
      color: var(--text-primary);
      font-family: var(--font-body);
      font-size: 1rem;
      margin-bottom: 16px;
      transition: all 0.2s ease;
    }
    .auth-input:focus {
      outline: none;
      border-color: var(--accent-cyan);
      box-shadow: 0 0 0 3px var(--glow-cyan);
    }
    .auth-input::placeholder { color: var(--text-tertiary); }
    .auth-btn {
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--accent-cyan), #00B894);
      color: var(--bg-deep);
      font-family: var(--font-display);
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .auth-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px -8px var(--glow-cyan); }
    .auth-btn:active { transform: translateY(0); }
    .auth-error { color: var(--accent-rose); font-size: 0.85rem; margin-top: 12px; display: none; }
    .auth-error.visible { display: block; animation: shake 0.4s ease; }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-6px); }
      75% { transform: translateX(6px); }
    }
    
    /* App Content */
    .app-content { display: none; }
    .app-content.visible { display: block; animation: contentReveal 0.6s ease; }
    @keyframes contentReveal { from { opacity: 0; } to { opacity: 1; } }
    
    /* Layout */
    .container { max-width: 1400px; margin: 0 auto; padding: 32px 24px; }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      padding-bottom: 24px;
      border-bottom: 1px solid var(--border-subtle);
    }
    .header-left { display: flex; align-items: center; gap: 20px; }
    .logo {
      font-family: var(--font-display);
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.03em;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent-cyan), var(--accent-violet));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    
    /* Trust Badge */
    .trust-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 100px;
      font-family: var(--font-display);
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .trust-badge.stable { 
      background: rgba(0,212,170,0.1); 
      color: var(--accent-cyan);
      box-shadow: 0 0 20px -5px var(--glow-cyan);
    }
    .trust-badge.caution { background: rgba(245,158,11,0.1); color: var(--accent-amber); }
    .trust-badge.at-risk { background: rgba(244,63,94,0.1); color: var(--accent-rose); }
    .trust-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* Theme Toggle */
    .theme-toggle {
      display: flex;
      background: var(--bg-float);
      border: 1px solid var(--border-subtle);
      border-radius: 100px;
      padding: 4px;
      cursor: pointer;
    }
    .theme-option {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 100px;
      font-family: var(--font-display);
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      transition: all 0.25s ease;
    }
    .theme-option.active {
      background: var(--bg-elevated);
      color: var(--text-primary);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .header-meta {
      font-size: 0.85rem;
      color: var(--text-tertiary);
    }
    .header-meta .highlight { color: var(--accent-violet); font-weight: 500; }
    
    /* Grid */
    .grid {
      display: grid;
      gap: 20px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 768px) { .grid { grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1200px) { .grid { grid-template-columns: repeat(4, 1fr); } }
    
    /* Panels */
    .panel {
      background: linear-gradient(145deg, var(--bg-elevated) 0%, var(--bg-float) 100%);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      animation: panelReveal 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
    }
    .panel:nth-child(1) { animation-delay: 0.1s; }
    .panel:nth-child(2) { animation-delay: 0.2s; }
    .panel:nth-child(3) { animation-delay: 0.3s; }
    .panel:nth-child(4) { animation-delay: 0.4s; }
    @keyframes panelReveal {
      from { opacity: 0; transform: translateY(20px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .panel:hover {
      border-color: var(--border-default);
      box-shadow: 
        0 12px 40px -12px rgba(0,0,0,0.4),
        0 0 0 1px var(--border-default),
        inset 0 1px 0 rgba(255,255,255,0.03);
      transform: translateY(-2px);
    }
    /* Top gradient line */
    .panel::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent 0%, var(--accent-cyan) 30%, var(--accent-violet) 70%, transparent 100%);
      opacity: 0;
      transition: opacity 0.4s ease;
    }
    .panel:hover::before { opacity: 1; }
    /* Corner accent */
    .panel::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 80px;
      height: 80px;
      background: radial-gradient(circle at top right, var(--glow-cyan), transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }
    .panel:hover::after { opacity: 0.3; }
    /* Panel-specific accents */
    .panel:nth-child(1)::after { background: radial-gradient(circle at top right, var(--glow-cyan), transparent 70%); }
    .panel:nth-child(2)::after { background: radial-gradient(circle at top right, var(--glow-violet), transparent 70%); }
    .panel:nth-child(3)::after { background: radial-gradient(circle at top right, rgba(245,158,11,0.3), transparent 70%); }
    .panel:nth-child(4)::after { background: radial-gradient(circle at top right, rgba(59,130,246,0.3), transparent 70%); }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .panel-title {
      font-family: var(--font-display);
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }
    .panel-icon { font-size: 1.25rem; opacity: 0.7; }
    .count-badge {
      background: var(--accent-violet);
      color: white;
      font-size: 0.7rem;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 100px;
      margin-left: 8px;
    }
    
    /* Status Elements */
    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--border-subtle);
    }
    .status-row:last-child { border-bottom: none; }
    .status-label { font-size: 0.875rem; color: var(--text-secondary); }
    .status-value { font-weight: 500; display: flex; align-items: center; gap: 8px; }
    
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    .status-pill.online { background: rgba(0,212,170,0.12); color: var(--accent-cyan); }
    .status-pill.offline { background: rgba(244,63,94,0.12); color: var(--accent-rose); }
    .status-pill.active { background: rgba(139,92,246,0.12); color: var(--accent-violet); }
    .status-pill.idle { background: rgba(59,130,246,0.12); color: var(--accent-blue); }
    .status-pill.stale { background: rgba(244,63,94,0.12); color: var(--accent-rose); }
    .status-pill.writable { background: rgba(0,212,170,0.12); color: var(--accent-cyan); }
    .status-pill.read-only { background: rgba(245,158,11,0.12); color: var(--accent-amber); }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .status-dot.ok { background: var(--accent-cyan); box-shadow: 0 0 8px var(--glow-cyan); }
    .status-dot.degraded { background: var(--accent-amber); }
    .status-dot.down { background: var(--accent-rose); }
    
    /* Services Grid */
    .services-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 16px;
    }
    .service-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    .service-name { text-transform: capitalize; }
    
    /* Server Health */
    .server-section { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-subtle); }
    .section-label {
      font-family: var(--font-display);
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
      margin-bottom: 12px;
    }
    .metric-row { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .metric-bar { flex: 1; height: 6px; background: var(--bg-float); border-radius: 100px; overflow: hidden; }
    .metric-fill { height: 100%; border-radius: 100px; transition: width 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
    .metric-fill.green { background: linear-gradient(90deg, var(--accent-cyan), #00B894); }
    .metric-fill.amber { background: linear-gradient(90deg, var(--accent-amber), #F97316); }
    .metric-fill.red { background: linear-gradient(90deg, var(--accent-rose), #E11D48); }
    .metric-info { min-width: 140px; display: flex; justify-content: space-between; font-size: 0.8rem; }
    .metric-name { font-weight: 500; color: var(--text-primary); }
    .metric-detail { color: var(--text-tertiary); }
    
    /* Summary */
    .summary-good { color: var(--accent-cyan); font-weight: 500; font-size: 0.875rem; margin-top: 16px; display: flex; align-items: center; gap: 6px; }
    
    /* Work Item */
    .work-card {
      background: var(--bg-float);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
    }
    .work-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .work-name { font-weight: 600; color: var(--text-primary); }
    .work-blocker {
      margin-top: 12px;
      padding: 10px 12px;
      background: rgba(244,63,94,0.08);
      border-left: 3px solid var(--accent-rose);
      border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
      font-size: 0.85rem;
      color: var(--accent-rose);
    }
    .work-countdown {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
      font-size: 0.8rem;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .countdown-tag { padding: 2px 8px; border-radius: 4px; font-weight: 500; }
    .countdown-tag.warning { background: rgba(245,158,11,0.12); color: var(--accent-amber); }
    .countdown-tag.urgent { background: rgba(244,63,94,0.12); color: var(--accent-rose); }
    
    /* Completions */
    .completion-list { list-style: none; }
    .completion-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 0.875rem;
    }
    .completion-item:last-child { border-bottom: none; }
    .completion-task { color: var(--text-primary); }
    .completion-date { color: var(--text-tertiary); font-size: 0.8rem; }
    
    /* Metrics Grid */
    .metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .metric-card {
      text-align: center;
      padding: 20px 12px;
      background: var(--bg-float);
      border-radius: var(--radius-md);
    }
    .metric-value {
      font-family: var(--font-display);
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-cyan);
      letter-spacing: -0.02em;
    }
    .metric-value.warning { color: var(--accent-amber); }
    .metric-value.good { color: var(--accent-cyan); }
    .metric-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-tertiary);
      margin-top: 4px;
    }
    .metric-countdown-small { font-size: 0.7rem; color: var(--text-tertiary); margin-top: 4px; }
    .metric-countdown-small.warning { color: var(--accent-amber); }
    .metric-countdown-small.urgent { color: var(--accent-rose); }
    
    /* Approvals */
    .approval-card {
      background: var(--bg-float);
      border-radius: var(--radius-md);
      padding: 14px;
      margin-bottom: 10px;
    }
    .approval-card:last-child { margin-bottom: 0; }
    .approval-headline {
      border-left: 3px solid var(--accent-amber);
      padding-left: 12px;
      margin-bottom: 12px;
    }
    .approval-headline-text { font-weight: 600; color: var(--accent-amber); font-size: 0.9rem; }
    .approval-desc { font-weight: 500; color: var(--text-primary); margin-bottom: 6px; }
    .approval-meta { display: flex; justify-content: space-between; font-size: 0.8rem; }
    .approval-reason { color: var(--accent-blue); }
    .approval-age { color: var(--accent-amber); }
    .approval-source { font-size: 0.75rem; color: var(--text-tertiary); margin-top: 6px; }
    
    /* Governance */
    .governance-row { display: flex; align-items: center; gap: 8px; font-size: 0.875rem; }
    .governance-row.aligned { color: var(--accent-cyan); }
    .governance-row.mismatch { color: var(--accent-amber); }
    
    /* Empty States */
    .empty-state { text-align: center; padding: 32px 16px; color: var(--text-tertiary); font-style: italic; }
    .empty-state.compact { padding: 20px 16px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    
    /* Loading & Error */
    .loading { display: flex; justify-content: center; align-items: center; min-height: 300px; color: var(--text-tertiary); }
    .error-state { text-align: center; padding: 48px; color: var(--accent-rose); }
    .error-state h2 { font-family: var(--font-display); margin-bottom: 12px; }
    
    /* Pending Queue */
    .pending-toggle {
      background: none;
      border: none;
      color: var(--accent-violet);
      font-size: 0.8rem;
      cursor: pointer;
      padding: 8px 0;
      font-family: var(--font-body);
    }
    .pending-toggle:hover { text-decoration: underline; }
    .pending-list { margin-top: 8px; padding: 12px; background: var(--bg-float); border-radius: var(--radius-sm); display: none; }
    .pending-list.expanded { display: block; }
    .pending-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-subtle); font-size: 0.8rem; }
    .pending-item:last-child { border-bottom: none; }
    .pending-type { color: var(--accent-violet); text-transform: uppercase; font-weight: 600; font-size: 0.7rem; }
    .pending-reason { color: var(--text-tertiary); }
    .pending-age { color: var(--accent-amber); }
    
    /* Responsive */
    @media (max-width: 767px) {
      .container { padding: 20px 16px; }
      .header { flex-direction: column; align-items: flex-start; gap: 16px; }
      .header-left { flex-direction: column; align-items: flex-start; gap: 12px; }
      .services-grid { flex-direction: column; }
      .metrics-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="ambient-bg"></div>
  
  <!-- Auth Overlay -->
  <div class="auth-overlay" id="auth-overlay">
    <div class="auth-card">
      <div class="auth-icon">ü¶ä</div>
      <div class="auth-logo">FlowDesk</div>
      <p class="auth-subtitle">Enter password to continue</p>
      <input type="password" class="auth-input" id="auth-password" placeholder="Password" autocomplete="off">
      <label class="remember-label">
        <input type="checkbox" id="auth-remember" class="remember-checkbox">
        <span class="remember-check"></span>
        <span>Remember me</span>
      </label>
      <button class="auth-btn" onclick="checkPassword()">Continue</button>
      <div class="auth-error" id="auth-error">Incorrect password</div>
    </div>
  </div>
  
  <div class="app-content" id="app-content">
    <div class="container">
      <header class="header">
        <div class="header-left">
          <div class="logo">
            <div class="logo-icon">ü¶ä</div>
            <span>FlowDesk</span>
          </div>
          <div id="trust-state"></div>
          <div class="theme-toggle" id="theme-toggle">
            <span class="theme-option light-opt">‚òÄÔ∏è Light</span>
            <span class="theme-option dark-opt active">üåô Dark</span>
          </div>
        </div>
        <div class="header-meta">
          <span id="generated-at">Loading...</span>
          <span class="highlight" id="generated-by"></span>
        </div>
      </header>
      <div id="dashboard" class="loading">Loading dashboard...</div>
    </div>
  </div>
  
  <script>
    // Theme toggle
    function getTheme() { try { return localStorage.getItem('flowdesk-theme'); } catch(e) { return null; } }
    function setTheme(theme) { try { localStorage.setItem('flowdesk-theme', theme); } catch(e) {} }
    function toggleTheme() {
      var html = document.documentElement;
      var lightOpt = document.querySelector('.light-opt');
      var darkOpt = document.querySelector('.dark-opt');
      if (html.getAttribute('data-theme') === 'light') {
        html.removeAttribute('data-theme');
        lightOpt.classList.remove('active');
        darkOpt.classList.add('active');
        setTheme('dark');
      } else {
        html.setAttribute('data-theme', 'light');
        darkOpt.classList.remove('active');
        lightOpt.classList.add('active');
        setTheme('light');
      }
    }
    (function() {
      var saved = getTheme();
      if (saved === 'light') document.documentElement.setAttribute('data-theme', 'light');
      document.addEventListener('DOMContentLoaded', function() {
        var toggle = document.getElementById('theme-toggle');
        if (toggle) {
          if (saved === 'light') {
            document.querySelector('.dark-opt').classList.remove('active');
            document.querySelector('.light-opt').classList.add('active');
          }
          toggle.onclick = toggleTheme;
        }
      });
    })();
    
    async function loadData() {
      if (window.DASHBOARD_STATE) return window.DASHBOARD_STATE;
      try {
        const response = await fetch('/DASHBOARD_STATE.json');
        if (!response.ok) throw new Error('Failed to fetch');
        return await response.json();
      } catch (error) { throw new Error('Could not load dashboard state'); }
    }
    
    function formatRelativeTime(isoString) { if (!isoString) return 'Unknown'; const date = new Date(isoString); const now = new Date(); const diffMs = now - date; const diffMins = Math.floor(diffMs / 60000); const diffHours = Math.floor(diffMs / 3600000); const diffDays = Math.floor(diffMs / 86400000); if (diffMins < 1) return 'Just now'; if (diffMins < 60) return diffMins + ' min ago'; if (diffHours < 24) return diffHours + ' hour' + (diffHours > 1 ? 's' : '') + ' ago'; return diffDays + ' day' + (diffDays > 1 ? 's' : '') + ' ago'; }
    function formatDate(isoString) { if (!isoString) return ''; return new Date(isoString).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
    function formatDays(days) { if (days === null || days === undefined) return '‚Äî'; return days + ' day' + (days !== 1 ? 's' : ''); }
    function formatDaysDecimal(days) { if (days === null || days === undefined) return '‚Äî'; if (days < 1) return Math.round(days * 24) + 'h'; return days.toFixed(1) + 'd'; }
    function getThresholdClass(percent) { if (percent < 70) return 'green'; if (percent < 90) return 'amber'; return 'red'; }
    function getCountdownClass(daysUntil) { if (daysUntil <= 1) return 'urgent'; if (daysUntil <= 3) return 'warning'; return ''; }
    function togglePendingQueue() { var list = document.getElementById('pending-list'); var toggle = document.getElementById('pending-toggle'); if (list.classList.contains('expanded')) { list.classList.remove('expanded'); toggle.innerHTML = '‚ñ∂ Show details'; } else { list.classList.add('expanded'); toggle.innerHTML = '‚ñº Hide details'; } }
    
    function renderTrustState(ts) {
      var container = document.getElementById('trust-state');
      if (!ts) { container.innerHTML = ''; return; }
      var levelClass = ts.level === 'at-risk' ? 'at-risk' : ts.level;
      var levelText = ts.level === 'at-risk' ? 'At Risk' : ts.level.charAt(0).toUpperCase() + ts.level.slice(1);
      container.innerHTML = '<div class="trust-badge ' + levelClass + '"><span class="trust-dot"></span><span>' + levelText + '</span></div>';
    }
    
    function renderDashboard(data) {
      var dashboard = document.getElementById('dashboard');
      document.getElementById('generated-at').textContent = 'Updated ' + formatRelativeTime(data.generatedAt);
      if (data.generatedBy && data.generatedBy !== 'manual') document.getElementById('generated-by').textContent = ' ¬∑ ' + data.generatedBy;
      renderTrustState(data.trustState);
      
      var sh = data.systemHealth || {};
      var wp = data.workPulse || {};
      var pa = data.pendingApprovals || {};
      var gp = data.governancePulse || {};
      var sl = sh.sessionLock || {};
      var ga = gp.governanceAlignment || {};
      var pendingTotal = (sh.pendingOperationsCount || 0) + (sh.pendingMessagesCount || 0);
      var hasPendingQueue = pendingTotal > 0 && sh.pendingQueue && sh.pendingQueue.length > 0;
      
      dashboard.className = 'grid';
      dashboard.innerHTML = '' +
        '<div class="panel">' +
          '<div class="panel-header"><span class="panel-title">System Health</span><span class="panel-icon">üñ•Ô∏è</span></div>' +
          '<div class="status-row"><span class="status-label">Session</span><span class="status-pill ' + (sh.sessionActive ? 'online' : 'offline') + '">' + (sh.sessionActive ? 'Online' : 'Offline') + '</span></div>' +
          '<div class="status-row"><span class="status-label">State</span><span class="status-pill ' + (sh.currentState === 'active' ? 'active' : 'idle') + '">' + (sh.currentState === 'active' ? 'Active' : 'Idle') + '</span></div>' +
          (sh.activeTask ? '<div class="status-row"><span class="status-label">Task</span><span class="status-value">' + sh.activeTask + '</span></div>' : '') +
          '<div class="status-row"><span class="status-label">Heartbeat</span><span class="status-value">' + (sh.heartbeatStale ? '<span class="status-pill stale">Stale</span>' : '') + formatRelativeTime(sh.lastHeartbeat) + '</span></div>' +
          '<div class="status-row"><span class="status-label">Lock</span><span class="status-pill ' + (sl.status || 'writable') + '">' + (sl.status === 'read-only' ? 'Read-Only' : sl.status === 'stale' ? 'Stale' : 'Writable') + '</span></div>' +
          '<div class="status-row"><span class="status-label">Pending</span><span class="status-value"><span class="status-dot ' + (pendingTotal > 0 ? 'degraded' : 'ok') + '"></span>' + (sh.pendingOperationsCount || 0) + ' / ' + (sh.pendingMessagesCount || 0) + '</span></div>' +
          (hasPendingQueue ? '<button class="pending-toggle" id="pending-toggle" onclick="togglePendingQueue()">‚ñ∂ Show details</button><div class="pending-list" id="pending-list">' + sh.pendingQueue.map(function(item) { return '<div class="pending-item"><div><span class="pending-type">' + item.type + '</span> ' + (item.action || item.target || '') + '</div><div><span class="pending-reason">' + item.reason + '</span> ¬∑ <span class="pending-age">' + item.ageMinutes + 'm</span></div></div>'; }).join('') + '</div>' : '') +
          '<div class="services-grid">' + Object.entries(sh.services || {}).map(function(entry) { return '<div class="service-item"><span class="status-dot ' + entry[1] + '"></span><span class="service-name">' + entry[0] + '</span></div>'; }).join('') + '</div>' +
          (sh.server ? '<div class="server-section"><div class="section-label">Server</div>' +
            '<div class="metric-row"><span class="metric-bar"><span class="metric-fill ' + getThresholdClass(sh.server.diskUsedPercent) + '" style="width:' + sh.server.diskUsedPercent + '%"></span></span><span class="metric-info"><span class="metric-name">Disk</span><span class="metric-detail">' + sh.server.diskUsedGb + '/' + sh.server.diskTotalGb + ' GB</span></span></div>' +
            '<div class="metric-row"><span class="metric-bar"><span class="metric-fill ' + getThresholdClass(sh.server.ramUsedPercent) + '" style="width:' + sh.server.ramUsedPercent + '%"></span></span><span class="metric-info"><span class="metric-name">RAM</span><span class="metric-detail">' + (Math.round(sh.server.ramUsedMb / 1024 * 10) / 10) + '/' + (Math.round(sh.server.ramTotalMb / 1024 * 10) / 10) + ' GB</span></span></div>' +
            '<div class="metric-row"><span class="metric-bar"><span class="metric-fill ' + getThresholdClass(sh.server.cpuLoad * 100) + '" style="width:' + Math.min(sh.server.cpuLoad * 100, 100) + '%"></span></span><span class="metric-info"><span class="metric-name">CPU</span><span class="metric-detail">Load ' + sh.server.cpuLoad + '</span></span></div>' +
            '<div class="status-row" style="margin-top:8px"><span class="status-label">Uptime</span><span class="status-value">' + sh.server.uptimeDays + 'd ' + sh.server.uptimeHours + 'h</span></div></div>' : '') +
          (Object.values(sh.services || {}).every(function(s) { return s === 'ok'; }) ? '<div class="summary-good">‚úì All Systems Operational</div>' : '') +
        '</div>' +
        
        '<div class="panel">' +
          '<div class="panel-header"><span class="panel-title">Work Pulse</span><span class="panel-icon">‚ö°</span></div>' +
          (wp.activeItem && wp.activeItem.name ? 
            '<div class="work-card">' +
              '<div class="work-header"><span class="work-name">' + wp.activeItem.name + '</span><span class="status-pill ' + (wp.activeItem.status === 'blocked' ? 'stale' : wp.activeItem.status === 'active' ? 'active' : 'idle') + '">' + (wp.activeItem.status || 'idle') + '</span></div>' +
              '<div class="status-row"><span class="status-label">Last touched</span><span class="status-value">' + formatDays(wp.activeItem.daysSinceTouch) + ' ago' + (wp.staleFlag ? ' ‚ö†Ô∏è' : '') + '</span></div>' +
              (wp.activeItem.blocker ? '<div class="work-blocker">' + wp.activeItem.blocker + '</div>' : '') +
              (wp.activeItem.daysUntilStale !== null && wp.activeItem.daysUntilStale !== undefined ? '<div class="work-countdown">‚è±Ô∏è <span class="countdown-tag ' + getCountdownClass(wp.activeItem.daysUntilStale) + '">Stalls in ' + formatDaysDecimal(wp.activeItem.daysUntilStale) + '</span></div>' : '') +
            '</div>' 
            : '<div class="empty-state">No active work</div>') +
          '<div class="section-label">Completed This Week</div>' +
          (wp.completedThisWeek && wp.completedThisWeek.length > 0 ? 
            '<ul class="completion-list">' + wp.completedThisWeek.slice(0, 5).map(function(item) { return '<li class="completion-item"><span class="completion-task">' + item.task + '</span><span class="completion-date">' + formatDate(item.completedAt) + '</span></li>'; }).join('') + '</ul>' 
            : '<div class="empty-state">No completions yet</div>') +
        '</div>' +
        
        '<div class="panel">' +
          '<div class="panel-header"><span class="panel-title">Pending Approvals</span>' + (pa.count > 0 ? '<span class="count-badge">' + pa.count + '</span>' : '') + '<span class="panel-icon">‚è≥</span></div>' +
          (pa.headline ? '<div class="approval-headline"><div class="approval-headline-text">Awaiting: ' + pa.headline + '</div></div>' : '') +
          (pa.items && pa.items.length > 0 ? 
            pa.items.map(function(item) { return '<div class="approval-card"><div class="approval-desc">' + item.description + '</div><div class="approval-meta"><span class="approval-reason">' + item.reason + '</span><span class="approval-age">' + item.age + '</span></div><div class="approval-source">Source: ' + item.source + '</div></div>'; }).join('') 
            : '<div class="empty-state compact"><span class="status-dot ok"></span>No pending approvals</div>') +
        '</div>' +
        
        '<div class="panel">' +
          '<div class="panel-header"><span class="panel-title">Governance Pulse</span><span class="panel-icon">üìã</span></div>' +
          '<div class="metrics-grid">' +
            '<div class="metric-card"><div class="metric-value ' + (gp.debtCount > 0 ? (gp.oldestDebtDays > 14 ? 'warning' : '') : 'good') + '">' + (gp.debtCount || 0) + '</div><div class="metric-label">Open Debt</div>' + (gp.oldestDebtDaysUntilAlert !== null && gp.oldestDebtDaysUntilAlert !== undefined && gp.debtCount > 0 ? '<div class="metric-countdown-small ' + getCountdownClass(gp.oldestDebtDaysUntilAlert) + '">Alert in ' + gp.oldestDebtDaysUntilAlert + 'd</div>' : '') + '</div>' +
            '<div class="metric-card"><div class="metric-value ' + (gp.oldestDebtDays > 14 ? 'warning' : '') + '">' + formatDays(gp.oldestDebtDays) + '</div><div class="metric-label">Oldest Debt</div></div>' +
            '<div class="metric-card"><div class="metric-value">' + (gp.alertsThisWeek || 0) + '</div><div class="metric-label">Alerts</div></div>' +
            '<div class="metric-card"><div class="metric-value ' + (gp.unpropagatedCorrections > 0 ? 'warning' : 'good') + '">' + (gp.unpropagatedCorrections || 0) + '</div><div class="metric-label">Corrections</div></div>' +
          '</div>' +
          '<div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border-subtle)">' +
            '<div class="status-row"><span class="status-label">Scorecard</span><span class="status-value">' + (gp.latestScorecard && gp.latestScorecard.date ? formatDate(gp.latestScorecard.date) + (gp.latestScorecard.summary ? ' ¬∑ ' + gp.latestScorecard.summary : '') : 'No reviews yet') + '</span></div>' +
            '<div class="status-row"><span class="status-label">Governance</span><span class="governance-row ' + (ga.aligned !== false ? 'aligned' : 'mismatch') + '">' + (ga.aligned !== false ? '‚úì Aligned' : '‚ö†Ô∏è Mismatch') + '</span></div>' +
          '</div>' +
        '</div>';
    }
    
    function renderError(message) {
      var dashboard = document.getElementById('dashboard');
      dashboard.className = '';
      dashboard.innerHTML = '<div class="error-state"><h2>Dashboard Unavailable</h2><p>' + message + '</p><p style="margin-top:16px;font-size:0.875rem;color:var(--text-tertiary)">Trigger refresh via Telegram: "dashboard"</p></div>';
    }
    
    loadData().then(renderDashboard).catch(function(err) { renderError(err.message); });
  </script>
  
  <script>
    // Password Gate
    var PASS = '(DashBoard)';
    function checkPassword() {
      var input = document.getElementById('auth-password').value;
      var remember = document.getElementById('auth-remember').checked;
      if (input === PASS) {
        try {
          if (remember) {
            localStorage.setItem('flowdesk-auth', 'true');
          } else {
            sessionStorage.setItem('flowdesk-auth', 'true');
          }
        } catch(e) {}
        document.getElementById('auth-overlay').classList.add('hidden');
        document.getElementById('app-content').classList.add('visible');
      } else {
        document.getElementById('auth-error').classList.add('visible');
      }
    }
    document.getElementById('auth-password').addEventListener('keypress', function(e) { if (e.key === 'Enter') checkPassword(); });
    (function() {
      try {
        if (localStorage.getItem('flowdesk-auth') === 'true' || sessionStorage.getItem('flowdesk-auth') === 'true') {
          document.getElementById('auth-overlay').classList.add('hidden');
          document.getElementById('app-content').classList.add('visible');
        }
      } catch(e) {}
    })();
  </script>
</body>
</html>
