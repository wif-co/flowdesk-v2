<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FlowDesk v2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Colors - DESIGN_TOKENS.md */
      --color-primary: #1E3A5F;
      --color-accent: #D4AF37;
      --color-background: #FFFEF5;
      --color-surface: #F5F5F0;
      --color-text: #2D2D2D;
      --color-success: #2E7D5B;
      --color-warning: #C9A227;
      --color-error: #B54A4A;
      --color-info: #3A6B8C;
      
      /* Typography */
      --font-heading: 'Playfair Display', Georgia, serif;
      --font-body: 'Source Sans 3', 'Segoe UI', sans-serif;
      
      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-6: 24px;
      --space-8: 32px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: var(--font-body);
      background: var(--color-background);
      color: var(--color-text);
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-6);
    }
    
    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-8);
      padding-bottom: var(--space-4);
      border-bottom: 2px solid var(--color-accent);
    }
    
    .header h1 {
      font-family: var(--font-heading);
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-primary);
    }
    
    .header .meta {
      font-size: 0.875rem;
      color: #666;
    }
    
    .header .meta .generated-by {
      color: var(--color-info);
      font-weight: 600;
    }
    
    /* Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: var(--space-6);
    }
    
    /* Panel */
    .panel {
      background: #FFFFFF;
      border: 1px solid #E8E8E0;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: var(--space-6);
    }
    
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid #E8E8E0;
    }
    
    .panel-header h2 {
      font-family: var(--font-heading);
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-primary);
    }
    
    .panel-header .icon {
      font-size: 1.25rem;
    }
    
    /* Status Indicators */
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: var(--space-2);
    }
    
    .status-dot.ok { background: var(--color-success); }
    .status-dot.degraded { background: var(--color-warning); }
    .status-dot.down { background: var(--color-error); }
    
    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: var(--space-1) var(--space-3);
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .status-badge.online {
      background: rgba(46, 125, 91, 0.1);
      color: var(--color-success);
    }
    
    .status-badge.offline {
      background: rgba(181, 74, 74, 0.1);
      color: var(--color-error);
    }
    
    .status-badge.active {
      background: rgba(212, 175, 55, 0.1);
      color: var(--color-warning);
    }
    
    .status-badge.idle {
      background: rgba(58, 107, 140, 0.1);
      color: var(--color-info);
    }
    
    .status-badge.stale {
      background: rgba(181, 74, 74, 0.1);
      color: var(--color-error);
    }
    
    /* Rows */
    .row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-3) 0;
      border-bottom: 1px solid #F0F0E8;
    }
    
    .row:last-child {
      border-bottom: none;
    }
    
    .row-label {
      font-size: 0.875rem;
      color: #666;
    }
    
    .row-value {
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    
    /* Services Grid */
    .services-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-3);
      margin-top: var(--space-3);
    }
    
    .service-item {
      display: flex;
      align-items: center;
      font-size: 0.875rem;
    }
    
    .service-name {
      text-transform: capitalize;
    }
    
    /* Work Item */
    .work-item {
      background: var(--color-surface);
      border-radius: 6px;
      padding: var(--space-4);
      margin-bottom: var(--space-4);
    }
    
    .work-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-2);
    }
    
    .work-item-name {
      font-weight: 600;
      color: var(--color-primary);
    }
    
    .work-item-blocker {
      font-size: 0.875rem;
      color: var(--color-error);
      margin-top: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: rgba(181, 74, 74, 0.08);
      border-radius: 4px;
    }
    
    .work-item-blocker::before {
      content: "‚ö† ";
    }
    
    /* Completions List */
    .completions-list {
      list-style: none;
    }
    
    .completions-list li {
      padding: var(--space-2) 0;
      font-size: 0.875rem;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #F0F0E8;
    }
    
    .completions-list li:last-child {
      border-bottom: none;
    }
    
    .completion-task {
      color: var(--color-text);
    }
    
    .completion-date {
      color: #888;
      font-size: 0.8rem;
    }
    
    /* Metric Cards */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-4);
    }
    
    .metric-card {
      text-align: center;
      padding: var(--space-4);
      background: var(--color-surface);
      border-radius: 6px;
    }
    
    .metric-value {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--color-primary);
      font-family: var(--font-heading);
    }
    
    .metric-value.warning {
      color: var(--color-warning);
    }
    
    .metric-value.good {
      color: var(--color-success);
    }
    
    .metric-label {
      font-size: 0.8rem;
      color: #666;
      margin-top: var(--space-1);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-6);
      color: #888;
      font-style: italic;
    }
    
    /* Server Health */
    .server-health {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid #E8E8E0;
    }
    
    .server-metrics {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    
    .server-metric {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    
    .metric-bar {
      flex: 1;
      height: 8px;
      background: var(--color-surface);
      border-radius: 4px;
      overflow: hidden;
      min-width: 80px;
    }
    
    .metric-fill {
      display: block;
      height: 100%;
      border-radius: 4px;
      transition: width 0.3s ease;
    }
    
    .metric-fill.green { background: var(--color-success); }
    .metric-fill.amber { background: var(--color-warning); }
    .metric-fill.red { background: var(--color-error); }
    
    .metric-info {
      display: flex;
      justify-content: space-between;
      min-width: 140px;
      font-size: 0.8rem;
    }
    
    .metric-name {
      font-weight: 600;
      color: var(--color-text);
    }
    
    .metric-detail {
      color: #888;
    }
    
    /* Summary Row */
    .summary-row {
      margin-top: var(--space-4);
      padding-top: var(--space-4);
      border-top: 1px solid #E8E8E0;
    }
    
    .summary-text {
      font-size: 0.875rem;
      color: #666;
    }
    
    .summary-text.all-good {
      color: var(--color-success);
      font-weight: 600;
    }
    
    /* Loading State */
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      color: #888;
    }
    
    /* Error State */
    .error-state {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-error);
    }
    
    .error-state h2 {
      font-family: var(--font-heading);
      margin-bottom: var(--space-4);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: var(--space-4);
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
      }
      
      .grid {
        grid-template-columns: 1fr;
      }
      
      .services-grid {
        grid-template-columns: 1fr;
      }
      
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>ü¶ä FlowDesk</h1>
      <div class="meta">
        <span id="generated-at">Loading...</span>
        <span class="generated-by" id="generated-by"></span>
      </div>
    </header>
    
    <div id="dashboard" class="loading">
      Loading dashboard...
    </div>
  </div>
  
  <script>
    // Check for embedded data first (Canvas mode), fall back to fetch (Vercel mode)
    async function loadData() {
      if (window.DASHBOARD_STATE) {
        return window.DASHBOARD_STATE;
      }
      
      try {
        const response = await fetch('/DASHBOARD_STATE.json');
        if (!response.ok) throw new Error('Failed to fetch');
        return await response.json();
      } catch (error) {
        throw new Error('Could not load dashboard state');
      }
    }
    
    function formatRelativeTime(isoString) {
      if (!isoString) return 'Unknown';
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    }
    
    function formatDate(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    function getThresholdClass(percent) {
      if (percent < 70) return 'green';
      if (percent < 90) return 'amber';
      return 'red';
    }
    
    function renderDashboard(data) {
      const dashboard = document.getElementById('dashboard');
      const generatedAt = document.getElementById('generated-at');
      const generatedBy = document.getElementById('generated-by');
      
      // Header meta
      generatedAt.textContent = `Generated ${formatRelativeTime(data.generatedAt)}`;
      if (data.generatedBy && data.generatedBy !== 'manual') {
        generatedBy.textContent = ` ¬∑ ${data.generatedBy}`;
      }
      
      const sh = data.systemHealth || {};
      const wp = data.workPulse || {};
      const gp = data.governancePulse || {};
      
      dashboard.className = 'grid';
      dashboard.innerHTML = `
        <!-- Panel 1: System Health -->
        <div class="panel">
          <div class="panel-header">
            <h2>System Health</h2>
            <span class="icon">üñ•Ô∏è</span>
          </div>
          
          <div class="row">
            <span class="row-label">Session</span>
            <span class="status-badge ${sh.sessionActive ? 'online' : 'offline'}">
              ${sh.sessionActive ? 'Online' : 'Offline'}
            </span>
          </div>
          
          <div class="row">
            <span class="row-label">State</span>
            <span class="status-badge ${sh.currentState === 'active' ? 'active' : 'idle'}">
              ${sh.currentState === 'active' ? 'Active' : 'Idle'}
            </span>
          </div>
          
          ${sh.activeTask ? `
          <div class="row">
            <span class="row-label">Current Task</span>
            <span class="row-value">${sh.activeTask}</span>
          </div>
          ` : ''}
          
          <div class="row">
            <span class="row-label">Last Heartbeat</span>
            <span class="row-value">
              ${sh.heartbeatStale ? '<span class="status-badge stale">Stale</span>' : ''}
              ${formatRelativeTime(sh.lastHeartbeat)}
            </span>
          </div>
          
          <div class="row">
            <span class="row-label">Pending Operations</span>
            <span class="row-value">
              <span class="status-dot ${sh.pendingOperationsCount > 0 ? 'degraded' : 'ok'}"></span>
              ${sh.pendingOperationsCount || 0}
            </span>
          </div>
          
          <div class="services-grid">
            ${Object.entries(sh.services || {}).map(([name, status]) => `
              <div class="service-item">
                <span class="status-dot ${status}"></span>
                <span class="service-name">${name}</span>
              </div>
            `).join('')}
          </div>
          
          ${sh.server ? `
          <div class="server-health">
            <h3 style="font-size: 0.875rem; color: #666; margin: var(--space-4) 0 var(--space-3);">Server Health</h3>
            <div class="server-metrics">
              <div class="server-metric">
                <span class="metric-bar">
                  <span class="metric-fill ${getThresholdClass(sh.server.diskUsedPercent)}" style="width: ${sh.server.diskUsedPercent}%"></span>
                </span>
                <span class="metric-info">
                  <span class="metric-name">Disk</span>
                  <span class="metric-detail">${sh.server.diskUsedGb}/${sh.server.diskTotalGb} GB (${sh.server.diskUsedPercent}%)</span>
                </span>
              </div>
              <div class="server-metric">
                <span class="metric-bar">
                  <span class="metric-fill ${getThresholdClass(sh.server.ramUsedPercent)}" style="width: ${sh.server.ramUsedPercent}%"></span>
                </span>
                <span class="metric-info">
                  <span class="metric-name">RAM</span>
                  <span class="metric-detail">${Math.round(sh.server.ramUsedMb / 1024 * 10) / 10}/${Math.round(sh.server.ramTotalMb / 1024 * 10) / 10} GB (${sh.server.ramUsedPercent}%)</span>
                </span>
              </div>
              <div class="server-metric">
                <span class="metric-bar">
                  <span class="metric-fill ${getThresholdClass(sh.server.cpuLoad * 100)}" style="width: ${Math.min(sh.server.cpuLoad * 100, 100)}%"></span>
                </span>
                <span class="metric-info">
                  <span class="metric-name">CPU</span>
                  <span class="metric-detail">Load: ${sh.server.cpuLoad}</span>
                </span>
              </div>
            </div>
            <div class="row" style="margin-top: var(--space-2);">
              <span class="row-label">Uptime</span>
              <span class="row-value">${sh.server.uptimeDays}d ${sh.server.uptimeHours}h</span>
            </div>
          </div>
          ` : ''}
          
          ${Object.values(sh.services || {}).every(s => s === 'ok') ? `
          <div class="summary-row">
            <span class="summary-text all-good">‚úì All Systems Operational</span>
          </div>
          ` : ''}
        </div>
        
        <!-- Panel 2: Work Pulse -->
        <div class="panel">
          <div class="panel-header">
            <h2>Work Pulse</h2>
            <span class="icon">‚ö°</span>
          </div>
          
          ${wp.activeItem && wp.activeItem.name ? `
          <div class="work-item">
            <div class="work-item-header">
              <span class="work-item-name">${wp.activeItem.name}</span>
              <span class="status-badge ${wp.activeItem.status === 'blocked' ? 'stale' : wp.activeItem.status === 'active' ? 'active' : 'idle'}">
                ${wp.activeItem.status || 'idle'}
              </span>
            </div>
            <div class="row">
              <span class="row-label">Last touched</span>
              <span class="row-value ${wp.staleFlag ? 'warning' : ''}">
                ${wp.activeItem.daysSinceTouch || 0} day${wp.activeItem.daysSinceTouch !== 1 ? 's' : ''} ago
                ${wp.staleFlag ? ' ‚ö†Ô∏è' : ''}
              </span>
            </div>
            ${wp.activeItem.blocker ? `
            <div class="work-item-blocker">${wp.activeItem.blocker}</div>
            ` : ''}
          </div>
          ` : `
          <div class="empty-state">No active work</div>
          `}
          
          <h3 style="font-size: 0.875rem; color: #666; margin: var(--space-4) 0 var(--space-2);">
            Completed This Week
          </h3>
          
          ${wp.completedThisWeek && wp.completedThisWeek.length > 0 ? `
          <ul class="completions-list">
            ${wp.completedThisWeek.slice(0, 5).map(item => `
              <li>
                <span class="completion-task">${item.task}</span>
                <span class="completion-date">${formatDate(item.completedAt)}</span>
              </li>
            `).join('')}
          </ul>
          ` : `
          <div class="empty-state">No completions yet</div>
          `}
        </div>
        
        <!-- Panel 3: Governance Pulse -->
        <div class="panel">
          <div class="panel-header">
            <h2>Governance Pulse</h2>
            <span class="icon">üìã</span>
          </div>
          
          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value ${gp.debtCount > 0 ? (gp.oldestDebtDays > 14 ? 'warning' : '') : 'good'}">
                ${gp.debtCount || 0}
              </div>
              <div class="metric-label">Open Debt</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-value ${gp.oldestDebtDays > 14 ? 'warning' : ''}">
                ${gp.oldestDebtDays !== null ? gp.oldestDebtDays + 'd' : '‚Äî'}
              </div>
              <div class="metric-label">Oldest Debt Age</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-value">
                ${gp.alertsThisWeek || 0}
              </div>
              <div class="metric-label">Alerts This Week</div>
            </div>
            
            <div class="metric-card">
              <div class="metric-value ${gp.unpropagatedCorrections > 0 ? 'warning' : 'good'}">
                ${gp.unpropagatedCorrections || 0}
              </div>
              <div class="metric-label">Unpropagated Corrections</div>
            </div>
          </div>
          
          <div class="summary-row">
            <div class="row">
              <span class="row-label">Latest Scorecard</span>
              <span class="row-value">
                ${gp.latestScorecard && gp.latestScorecard.date 
                  ? `${formatDate(gp.latestScorecard.date)}${gp.latestScorecard.summary ? ' ¬∑ ' + gp.latestScorecard.summary : ''}`
                  : 'No reviews yet'}
              </span>
            </div>
          </div>
        </div>
      `;
    }
    
    function renderError(message) {
      const dashboard = document.getElementById('dashboard');
      dashboard.className = '';
      dashboard.innerHTML = `
        <div class="error-state">
          <h2>Dashboard Unavailable</h2>
          <p>${message}</p>
          <p style="margin-top: var(--space-4); font-size: 0.875rem;">
            Trigger a refresh via Telegram: "dashboard" or "refresh dashboard"
          </p>
        </div>
      `;
    }
    
    // Initialize
    loadData()
      .then(renderDashboard)
      .catch(err => renderError(err.message));
  </script>
</body>
</html>
